name: cd
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: cd-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  semver_label_check:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Debug labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            core.info(`PR labels: ${labels.join(', ') || '(none)'}`);

      - name: Ensure semver label is present
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const allowed = ['semver: major', 'semver: minor', 'semver: patch'];
            const present = allowed.find(label => labels.includes(label));
            if (!present) {
              core.setFailed('PR must include one semver label: semver: major | semver: minor | semver: patch');
            } else {
              core.info(`Found semver label: ${present}`);
            }

  release_notes_check:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          notes_file: 'docs/release_notes/release_notes.md'

  deploy_android:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    needs: [semver_label_check, release_notes_check]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout (root for actions)
        uses: actions/checkout@v4

      - name: Checkout (app code)
        uses: actions/checkout@v4
        with:
          path: app

      - name: Inject Doppler Preview Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PREVIEW_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: preview
          working_directory: app

      - name: Deploy android app to Firebase App Distribution
        uses: ./.github/actions/deploy_android_preview
        with:
          ANDROID_GCP_JSON_BASE64: ${{ secrets.ANDROID_GCP_JSON_BASE64 }}
          ANDROID_FIREBASE_PROJECT_NUMBER: ${{ secrets.ANDROID_FIREBASE_PROJECT_NUMBER }}
          ANDROID_FIREBASE_APP_ID: ${{ secrets.ANDROID_FIREBASE_APP_ID }}
          ANDROID_FIREBASE_PROJECT_ID: ${{ secrets.ANDROID_FIREBASE_PROJECT_ID }}
          ANDROID_FIREBASE_APP_PACKAGE: ${{ secrets.ANDROID_FIREBASE_APP_PACKAGE }}
          ANDROID_FIREBASE_API_KEY: ${{ secrets.ANDROID_FIREBASE_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}

      - name: Post or update PR comment (Android)
        uses: ./.github/actions/update_preview_comment
        with:
          platform: android
          android_firebase_project_id: ${{ secrets.ANDROID_FIREBASE_PROJECT_ID }}
          android_firebase_app_package: ${{ secrets.ANDROID_FIREBASE_APP_PACKAGE }}
          ios_app_store_connect_api_key_issuer_id: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          ios_apple_id: ${{ secrets.IOS_APPLE_ID }}

  deploy_ios:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    needs: [semver_label_check, release_notes_check]
    runs-on: macos-15
    timeout-minutes: 60
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject Doppler Preview Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PREVIEW_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: preview
          working_directory: "."

      - name: Deploy iOS Preview to TestFlight
        uses: ./.github/actions/deploy_ios_preview
        with:
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}
          IOS_MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
          IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
          IOS_APPLE_ID: ${{ secrets.IOS_APPLE_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_B64: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_B64 }}
          IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
          IOS_APP_STORE_TEAM_ID: ${{ secrets.IOS_APP_STORE_TEAM_ID }}
          IOS_DEV_EMAIL: ${{ secrets.IOS_DEV_EMAIL }}
          IOS_MATCH_DEPLOY_KEY: ${{ secrets.IOS_MATCH_DEPLOY_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
      
      - name: Post or update PR comment (IOS)
        uses: ./.github/actions/update_preview_comment
        with:
          platform: ios
          android_firebase_project_id: ${{ secrets.ANDROID_FIREBASE_PROJECT_ID }}
          android_firebase_app_package: ${{ secrets.ANDROID_FIREBASE_APP_PACKAGE }}
          ios_app_store_connect_api_key_issuer_id: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          ios_apple_id: ${{ secrets.IOS_APPLE_ID }}
