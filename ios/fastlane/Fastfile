default_platform(:ios)

platform :ios do
  desc "Setup code signing"
  lane :ci_signing_setup do
    match(
      type: "appstore",
      readonly: true,
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"]
    )
  end

  desc "Build IPA for App Store"
  lane :build_ipa do
    build_app(
      clean: true,
      scheme: ENV["IOS_SCHEME"] || "YourApp", # replace or set in secrets
      export_method: "app-store",
      output_directory: "./", # output .ipa in ios/
      xcargs: "CODE_SIGN_STYLE=Manual " \
              "CODE_SIGN_IDENTITY=\"Apple Distribution\" " \
              "DEVELOPMENT_TEAM=#{ENV['IOS_TEAM_ID']} " \
              "PROVISIONING_PROFILE_SPECIFIER=\"match AppStore #{ENV['IOS_APP_IDENTIFIER']}\" " \
              "PRODUCT_BUNDLE_IDENTIFIER=#{ENV['IOS_APP_IDENTIFIER']}",
      export_options: {
        compileBitcode: false,
        signingStyle: "manual",
        provisioningProfiles: {
          ENV['IOS_APP_IDENTIFIER'] => "match AppStore #{ENV['IOS_APP_IDENTIFIER']}"
        }
      }
    )
  end
end
