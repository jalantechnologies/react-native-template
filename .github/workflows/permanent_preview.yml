name: permanent-preview
on:
  push:
    branches:
      - vikram/test/permanent-preview

permissions:
  contents: write

concurrency:
  group: permanent-preview
  cancel-in-progress: true

jobs:
  release_notes_check:
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          version_file: 'package.json'
          notes_dir: 'docs/release_notes'
          notes_ext: '.md'

  build_android_preview:
    runs-on: ubuntu-latest
    needs: [release_notes_check]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Inject Doppler Preview Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PREVIEW_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: preview
          working_directory: .

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack
        run: corepack enable
        shell: bash

      - name: Install dependencies
        run: yarn install --immutable
        shell: bash

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Android release APK (preview)
        shell: bash
        working-directory: android
        run: |
          VERSION=$(jq -r .version ../package.json)
          BUILD_NUMBER=$(date -u +%s)
          ./gradlew assembleRelease -PversionName="$VERSION" -PversionCode="$BUILD_NUMBER"

      - name: Stage Android artifact
        shell: bash
        run: |
          mkdir -p preview-artifacts
          cp android/app/build/outputs/apk/release/app-release.apk preview-artifacts/react-native-template-preview.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-preview-release
          path: preview-artifacts/react-native-template-preview.apk
          if-no-files-found: error

  build_ios_preview:
    runs-on: macos-14
    timeout-minutes: 60
    needs: [release_notes_check]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Inject Doppler Preview Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PREVIEW_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: preview
          working_directory: .

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '.ruby-version'
          bundler-cache: true
          working-directory: ios

      - name: Select Xcode 16.2
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app
          export DEVELOPER_DIR="/Applications/Xcode_16.2.app/Contents/Developer"
          xcode-select -p
          xcodebuild -version
        shell: bash

      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Enable Corepack
        run: corepack enable
        shell: bash

      - name: Install dependencies
        run: yarn install --immutable
        shell: bash

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        working-directory: ios
        shell: bash
        run: |
          pod repo update
          bundle exec pod update boost --no-repo-update
          bundle exec pod install

      - name: Set up SSH for Match
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.IOS_MATCH_DEPLOY_KEY }}

      - name: Add GitHub to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
        shell: bash

      - name: Export Match password
        run: echo "MATCH_PASSWORD=${{ secrets.IOS_MATCH_PASSWORD }}" >> $GITHUB_ENV
        shell: bash

      - name: Clean Match cache
        run: rm -rf ~/.match
        shell: bash

      - name: Install code signing certificates via Match
        working-directory: ios
        run: bundle exec fastlane ci_signing_setup
        shell: bash
        env:
          MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
          IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
          IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}

      - name: Build iOS preview IPA
        working-directory: ios
        shell: bash
        env:
          IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
          IOS_APP_STORE_TEAM_ID: ${{ secrets.IOS_APP_STORE_TEAM_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
          MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
        run: |
          BUILD_NUMBER=$(date -u +%s)
          bundle exec fastlane ios preview_build \
            build_number:"$BUILD_NUMBER" \
            output_directory:"build/preview" \
            output_name:"react-native-template-preview.ipa"

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-preview-release
          path: ios/build/preview/react-native-template-preview.ipa
          if-no-files-found: error

  publish_preview_release:
    runs-on: ubuntu-latest
    needs: [release_notes_check, build_android_preview, build_ios_preview]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: preview-artifacts
          merge-multiple: true

      - name: Prepare release notes
        shell: bash
        run: |
          VERSION=$(jq -r .version package.json)
          echo "PREVIEW_VERSION=$VERSION" >> $GITHUB_ENV
          {
            echo "## Permanent Preview"
            echo ""
            echo "- Version: ${VERSION}"
            echo "- Commit: ${GITHUB_SHA}"
            echo ""
            echo "### Release Notes"
            echo "${{ needs.release_notes_check.outputs.release_notes }}"
          } > preview-release-notes.md

      - name: Create or update permanent preview release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          TAG="preview-v${PREVIEW_VERSION}"
          TITLE="Permanent Preview v${PREVIEW_VERSION}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --title "$TITLE" --notes-file preview-release-notes.md --draft=false --prerelease=false --latest
          else
            gh release create "$TAG" --title "$TITLE" --notes-file preview-release-notes.md --draft=false --prerelease=false --latest
          fi
          gh release upload "$TAG" preview-artifacts/* --clobber