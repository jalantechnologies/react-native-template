name: cd

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: cd-production
  cancel-in-progress: true

jobs:
  release_notes_check:
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          version_file: 'package.json'
          notes_dir: 'docs/release_notes'
          notes_ext: '.md'

      - name: Prepare Play Store changelog
        run: |
          DEST="android/fastlane/metadata/android/en-US/changelogs"
          mkdir -p "$DEST"
          NOTES="${{ steps.check.outputs.release_notes }}"
          MAX_LEN=500

          if [ ${#NOTES} -gt $MAX_LEN ]; then
            echo "Release notes exceed ${MAX_LEN} characters; truncating for Play Store."
            NOTES="${NOTES:0:$((MAX_LEN-3))}..."
          fi

          printf "%s\n" "$NOTES" > "$DEST/default.txt"

      - name: Upload Play Store changelog
        uses: actions/upload-artifact@v4
        with:
          name: play-release-notes
          path: android/fastlane/metadata/android/en-US/changelogs/default.txt

  auto_version_bump:
    runs-on: ubuntu-latest
    needs: [release_notes_check]
    outputs:
      release_notes: ${{ steps.capture_notes.outputs.release_notes }}
      version: ${{ steps.read_version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'

      - name: Bump version and rename release notes
        run: node scripts/bumpVersion.js

      - name: Read bumped version
        id: read_version
        run: |
          VERSION=$(jq -r .version < package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Capture bumped release notes
        id: capture_notes
        run: |
          NOTES_FILE="docs/release_notes/${{ steps.read_version.outputs.version }}.md"
          if [ ! -f "$NOTES_FILE" ]; then
            echo "::error::‚ùå Release notes file not found after bump: $NOTES_FILE"
            exit 1
          fi

          CONTENT=$(cat "$NOTES_FILE")
          {
            echo 'release_notes<<EOF'
            echo "$CONTENT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Upload bumped artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bumped-version
          path: |
            package.json
            docs/release_notes/${{ steps.read_version.outputs.version }}.md

  deploy_android:
    runs-on: ubuntu-latest
    needs: [release_notes_check, auto_version_bump]
    steps:
      - name: Checkout (app)
        uses: actions/checkout@v3

      - name: Download bumped version artifacts
        uses: actions/download-artifact@v4
        with:
          name: bumped-version
          path: bumped

      - name: Apply bumped artifacts
        run: |
          cp bumped/package.json package.json
          mkdir -p docs/release_notes
          cp bumped/docs/release_notes/*.md docs/release_notes/

      - name: Download Play Store changelog
        uses: actions/download-artifact@v4
        with:
          name: play-release-notes
          path: android/fastlane/metadata/android/en-US/changelogs

      - name: Deploy Android app to Play Store
        id: deploy_android_production
        uses: ./.github/actions/deploy_android_production
        with:
          GPLAY_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GPLAY_SERVICE_ACCOUNT_KEY_JSON }}
          ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          RELEASE_NOTES: ${{ needs.auto_version_bump.outputs.release_notes }}

  # deploy-ios:
  #   runs-on: macos-14
  #   needs: [release_notes_check]
  #   timeout-minutes: 30
  #   steps:
  #     - name: Checkout (app)
  #       uses: actions/checkout@v3

  #     - name: Deploy iOS app to App Store
  #       uses: ./.github/actions/deploy_ios_production
  #       with:
  #         MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
  #         IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
  #         IOS_APPLE_ID: ${{ secrets.IOS_APPLE_ID }}
  #         IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
  #         IOS_APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ID }}
  #         IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
  #         IOS_APP_STORE_CONNECT_API_KEY_B64: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_B64 }}
  #         IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
  #         IOS_APP_STORE_TEAM_ID: ${{ secrets.IOS_APP_STORE_TEAM_ID }}
  #         IOS_DEV_EMAIL: ${{ secrets.IOS_DEV_EMAIL }}
  #         IOS_MATCH_DEPLOY_KEY: ${{ secrets.IOS_MATCH_DEPLOY_KEY }}
  #         RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}