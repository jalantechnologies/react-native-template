name: cd

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: cd-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:

  check_version_number:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Compare package.json versions
        run: |
          # Fetch the main branch package.json
          git fetch origin main
          MAIN_VERSION=$(jq -r .version <(git show origin/main:package.json))
          PR_VERSION=$(jq -r .version < package.json)
          echo "Main branch version: $MAIN_VERSION"
          echo "PR branch version: $PR_VERSION"
          # Compare versions
          if [ "$(printf '%s\n%s' "$MAIN_VERSION" "$PR_VERSION" | sort -V | head -n1)" != "$MAIN_VERSION" ] || [ "$MAIN_VERSION" == "$PR_VERSION" ]; then
            echo "Error: PR version ($PR_VERSION) must be strictly greater than main version ($MAIN_VERSION)."
            exit 1
          fi

  release_notes_check:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          version_file: 'package.json'
          notes_dir: 'docs/release_notes'
          notes_ext: '.md'

      - name: Upload release notes artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ github.run_id }}
          path: |
            android/fastlane/metadata/android/en-US/changelogs/default.txt
            ios/fastlane/changelog.txt
            ios/fastlane/metadata/default/release_notes.txt
            ios/fastlane/metadata/en-US/release_notes.txt
          if-no-files-found: error

  deploy_android:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    needs: [check_version_number, release_notes_check]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (root for actions)
        uses: actions/checkout@v3

      - name: Checkout (app code)
        uses: actions/checkout@v3
        with:
          path: app

      - name: Inject Doppler Preview Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PREVIEW_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: preview
          working_directory: app

      - name: Deploy android app to Firebase App Distribution
        uses: ./.github/actions/deploy_android_preview
        with:
          ANDROID_GCP_JSON_BASE64: ${{ secrets.ANDROID_GCP_JSON_BASE64 }}
          ANDROID_FIREBASE_PROJECT_NUMBER: ${{ secrets.ANDROID_FIREBASE_PROJECT_NUMBER }}
          ANDROID_FIREBASE_APP_ID: ${{ secrets.ANDROID_FIREBASE_APP_ID }}
          ANDROID_FIREBASE_PROJECT_ID: ${{ secrets.ANDROID_FIREBASE_PROJECT_ID }}
          ANDROID_FIREBASE_APP_PACKAGE: ${{ secrets.ANDROID_FIREBASE_APP_PACKAGE }}
          ANDROID_FIREBASE_API_KEY: ${{ secrets.ANDROID_FIREBASE_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}
  deploy_ios:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    needs: [check_version_number, release_notes_check]
    runs-on: macos-14
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download release notes artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-notes-${{ github.run_id }}
          path: .

      - name: Deploy iOS Preview to TestFlight
        uses: ./.github/actions/deploy_ios_preview
        env:
          MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
          IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
          IOS_APPLE_ID: ${{ secrets.IOS_APPLE_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_B64: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_B64 }}
          IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
          IOS_APP_STORE_TEAM_ID: ${{ secrets.IOS_APP_STORE_TEAM_ID }}
          IOS_DEV_EMAIL: ${{ secrets.IOS_DEV_EMAIL }}
          IOS_MATCH_DEPLOY_KEY: ${{ secrets.IOS_MATCH_DEPLOY_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}
