name: cd
on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Version Bump"]
    types:
      - completed
  repository_dispatch:
    types: [run-production]

concurrency:
  group: cd-production
  cancel-in-progress: true

jobs:
  release_notes_check:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Set target ref/repo
        id: target
        run: |
          REF="${{ github.event.workflow_run.head_branch || github.event.client_payload.ref || github.ref_name }}"
          REPO="${{ github.event.workflow_run.repository.full_name || github.repository }}"
          echo "ref=${REF}" >> $GITHUB_OUTPUT
          echo "repo=${REPO}" >> $GITHUB_OUTPUT

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.ref }}
          repository: ${{ steps.target.outputs.repo }}

      - name: Echo version for deploy
        run: |
          VERSION=$(jq -r .version package.json)
          echo "Deploying version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "## Deploying version $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          version_file: 'package.json'
          notes_dir: 'docs/release_notes'
          notes_ext: '.md'

  deploy_android:
    runs-on: ubuntu-latest
    needs: [release_notes_check]
    steps:
      - name: Set target ref/repo
        id: target
        run: |
          REF="${{ github.event.workflow_run.head_branch || github.event.client_payload.ref || github.ref_name }}"
          REPO="${{ github.event.workflow_run.repository.full_name || github.repository }}"
          echo "ref=${REF}" >> $GITHUB_OUTPUT
          echo "repo=${REPO}" >> $GITHUB_OUTPUT

      - name: Checkout (app)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.ref }}
          repository: ${{ steps.target.outputs.repo }}

      - name: Inject Doppler Production Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PRODUCTION_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: production
          working_directory: .

      - name: Deploy Android app to Play Store
        id: deploy_android_production
        uses: ./.github/actions/deploy_android_production
        with:
          ANDROID_APP_IDENTIFIER: ${{ secrets.ANDROID_APP_IDENTIFIER }}
          GPLAY_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GPLAY_SERVICE_ACCOUNT_KEY_JSON }}
          ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}

  deploy_ios:
    runs-on: macos-15
    needs: [release_notes_check]
    timeout-minutes: 30
    steps:
      - name: Set target ref/repo
        id: target
        run: |
          REF="${{ github.event.workflow_run.head_branch || github.event.client_payload.ref || github.ref_name }}"
          REPO="${{ github.event.workflow_run.repository.full_name || github.repository }}"
          echo "ref=${REF}" >> $GITHUB_OUTPUT
          echo "repo=${REPO}" >> $GITHUB_OUTPUT

      - name: Checkout (app)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.ref }}
          repository: ${{ steps.target.outputs.repo }}
        
      - name: Inject Doppler Production Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PRODUCTION_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: production
          working_directory: . 
          
      - name: Deploy iOS app to App Store
        uses: ./.github/actions/deploy_ios_production
        with:
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}
          IOS_MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
          IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
          IOS_APPLE_ID: ${{ secrets.IOS_APPLE_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_B64: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_B64 }}
          IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
          IOS_APP_STORE_TEAM_ID: ${{ secrets.IOS_APP_STORE_TEAM_ID }}
          IOS_DEV_EMAIL: ${{ secrets.IOS_DEV_EMAIL }}
          IOS_MATCH_DEPLOY_KEY: ${{ secrets.IOS_MATCH_DEPLOY_KEY }}
