name: iOS PR Deploy

on:
  push:
    branches:
      - shivam/ios/preview-deployment

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30
    env:
      NO_FLIPPER: 1

    steps:
      - uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1

      - name: Install Bundler
        run: gem install bundler
      
      - name: Install Ruby dependencies
        working-directory: ios
        run: bundle install
      
      - name: Use Node.js 22.13.1
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        run: yarn install

      - name: Patch Boost Podspec with Custom Source
        working-directory: node_modules/react-native/third-party-podspecs
        run: |
          awk '
          /spec.source/ {
          print "  spec.source = { :http => '\''https://archives.boost.io/release/1.76.0/source/boost_1_76_0.tar.gz'\'', :sha256 => '\''7bd7ddceec1a1dfdcbdb3e609b60d01739c38390a5f956385a12f3122049f0ca'\'' }";
          skip=1; next
          }
          skip && /\}/ { skip=0; next }
          skip && /:sha256/ { next }
          { print }
          ' boost.podspec > boost.podspec.tmp && mv boost.podspec.tmp boost.podspec

      - name: Remove Flipper dependencies (hard cleanup)
        run: |
          rm -rf node_modules/react-native-flipper ios/Pods/Flipper* || true
          yarn install --check-files || true

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          rm -f Podfile.lock
          bundle exec pod install --repo-update

      - name: Set up SSH for Match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          echo "GIT_SSH_COMMAND=ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" >> $GITHUB_ENV

      - name: Tail Xcode Build Log
        run: |
          mkdir -p ~/Library/Logs/gym/
          touch ~/Library/Logs/gym/Boilerplate-Boilerplate.log
          tail -n 200 -f ~/Library/Logs/gym/Boilerplate-Boilerplate.log &
      
      - name: Check for Flipper in Podfile.lock
        run: |
          grep -i flipper ios/Podfile.lock && echo "❌ Flipper still present!" && exit 1 || echo "✅ Flipper not found"

      
      - name: Disable Embed Pods Frameworks script (CI workaround)
        run: |
          sed -i '' 's/if \[ -z "\$SCRIPT_OUTPUT_FILE_0" \]/if false/' ios/Pods/Target\ Support\ Files/Pods-Boilerplate/Pods-Boilerplate-frameworks.sh || echo "Patch failed (probably missing script)"

      - name: iOS PR Deploy to TestFlight
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          NO_FLIPPER: 1
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          bundle exec fastlane ios pr_deploy

      - name: Print last 100 lines of Xcode log
        if: failure()
        run: |
          tail -n 100 ~/Library/Logs/gym/Boilerplate-Boilerplate.log || echo "Log not found"