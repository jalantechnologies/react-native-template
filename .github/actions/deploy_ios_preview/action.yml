name: 'Deploy iOS App to TestFlight (Preview)'
description: 'Build and deploy the iOS app to TestFlight Preview using Fastlane'
inputs:
  IOS_MATCH_PASSWORD:
    required: true
    description: 'Match password for signing'
  IOS_MATCH_REPOSITORY_URL:
    required: true
    description: 'Match repository URL for certs'
  IOS_APPLE_ID:
    required: true
    description: 'Apple App ID for app'
  IOS_KEYCHAIN_PASSWORD:
    required: true
    description: 'Keychain password for Fastlane'
  IOS_APP_STORE_CONNECT_API_KEY_ID:
    required: true
    description: 'API Key ID for App Store Connect'
  IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID:
    required: true
    description: 'Issuer ID for App Store Connect'
  IOS_APP_STORE_CONNECT_API_KEY_B64:
    required: true
    description: 'Base64 encoded API key for App Store Connect'
  IOS_APP_IDENTIFIER:
    required: true
    description: 'Bundle ID for the app'
  IOS_APP_STORE_TEAM_ID:
    required: true
    description: 'App Store Team ID'
  IOS_DEV_EMAIL:
    required: true
    description: 'Developer Apple email'
  IOS_MATCH_DEPLOY_KEY:
    required: true
    description: 'SSH private key for Match repo'
  PR_NUMBER:
    required: false
    description: 'Pull request number for PR-specific builds'
  RELEASE_NOTES:
    required: true
    description: 'Release notes text to upload to TestFlight'

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v3

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1

    - name: Select Xcode 16.2
      run: |
        sudo xcode-select -s /Applications/Xcode_16.2.app
        export DEVELOPER_DIR="/Applications/Xcode_16.2.app/Contents/Developer"
        xcode-select -p
        xcodebuild -version
      shell: bash

    - name: Install Bundler
      run: gem install bundler
      shell: bash

    - name: Install Ruby dependencies
      working-directory: ios
      run: bundle install
      shell: bash

    - name: Set Node Version
      uses: actions/setup-node@v4
      with:
        node-version-file: .nvmrc

    - name: Enable Corepack
      run: corepack enable
      shell: bash

    - name: Install dependencies
      run: yarn install --immutable
      shell: bash

    - name: Setup App Icon for Release
      shell: bash
      run: |
        # Copy the 1024x1024 icon to AppIcon.appiconset
        cp ios/Resources/AppIcon-1024.png ios/Boilerplate/Images.xcassets/AppIcon.appiconset/AppIcon.png
        # Update Contents.json to use single icon format
        cat > ios/Boilerplate/Images.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
        {
          "images" : [
            {
              "filename" : "AppIcon.png",
              "idiom" : "universal",
              "platform" : "ios",
              "size" : "1024x1024"
            }
          ],
          "info" : {
            "author" : "xcode",
            "version" : 1
          }
        }
        EOF

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: |
          ios/Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods dependencies
      working-directory: ios
      shell: bash
      run: |
        pod repo update
        bundle exec pod update boost --no-repo-update
        bundle exec pod install

    - name: Set up SSH for Match
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ env.IOS_MATCH_DEPLOY_KEY }}

    - name: Add GitHub to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan github.com >> ~/.ssh/known_hosts
      shell: bash

    - name: Setup Keychain
      run: |
        security create-keychain -p ${{ env.IOS_KEYCHAIN_PASSWORD }} ios.keychain
        security set-keychain-settings -lut 21600 ios.keychain
        security unlock-keychain -p ${{ env.IOS_KEYCHAIN_PASSWORD }} ios.keychain
        security list-keychains -s ios.keychain
        security default-keychain -d user -s ios.keychain
      shell: bash

    - name: Export Match password
      run: echo "MATCH_PASSWORD=${{ env.MATCH_PASSWORD }}" >> $GITHUB_ENV
      shell: bash

    - name: Write iOS changelog for Fastlane
      shell: bash
      run: |
        CHANGELOG_PATH="ios/fastlane/changelog.txt"
        mkdir -p "$(dirname "$CHANGELOG_PATH")"
        echo "RELEASE NOTES: ${{env.RELEASE_NOTES}}"
        printf "%s" "${{ env.RELEASE_NOTES }}" > "$CHANGELOG_PATH"
        echo "üìù Wrote iOS changelog to $CHANGELOG_PATH"
        
    - name: Clean Match cache
      run: rm -rf ~/.match
      shell: bash

    - name: Install code signing certificates via Match
      working-directory: ios
      run: bundle exec fastlane ci_signing_setup
      shell: bash

    - name: Clear Derived Data
      run: rm -rf ~/Library/Developer/Xcode/DerivedData
      shell: bash

    - name: Bundle React Native for iOS
      run: |
        ENVFILE=.env.preview NODE_ENV=production npx react-native bundle \
          --entry-file index.js \
          --platform ios \
          --dev false \
          --bundle-output ios/main.jsbundle \
          --assets-dest .
      shell: bash

    - name: iOS PR Deploy to TestFlight
      working-directory: ios
      run: bundle exec fastlane ios pr_deploy
      shell: bash
    
    - name: Upload .ipa artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-preview-pr-${{ github.event.pull_request.number }}-${{ github.sha }}
        path: ios/Boilerplate.ipa
        retention-days: 1
        if-no-files-found: error
        compression-level: 6

    - name: Upload Xcode build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: xcode-build-logs
        path: /Users/runner/Library/Logs/gym/*.log

    - name: Post PR comment with TestFlight link
      if: ${{ env.PR_NUMBER != '' }}
      env:
        GH_TOKEN: ${{ env.GITHUB_TOKEN }}
        PR_NUMBER: ${{ env.PR_NUMBER }}
        BUILD_HASH: ${{ github.sha }}
        IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ env.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        IOS_APPLE_ID: ${{ env.IOS_APPLE_ID }}
      run: |
        brew install gh
        gh auth setup-git
        TESTFLIGHT_LINK="https://appstoreconnect.apple.com/teams/$IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID/apps/$IOS_APPLE_ID/testflight/ios"
        gh pr comment "$PR_NUMBER" --body "‚úÖ TestFlight build uploaded for PR #$PR_NUMBER

        - üîó [View in App Store Connect]($TESTFLIGHT_LINK)
        - üÜî App ID: \`${{ env.IOS_APP_IDENTIFIER }}\`
        - üß± Build Hash: \`$BUILD_HASH\`

        _This build was deployed by CI using Fastlane._"
      shell: bash
