name: cd
on:
  push:
    branches:
      - main
      - vikram/feat/add-auto-version-bumping
    paths:
      - docs/release_notes/**

concurrency:
  group: cd-production
  cancel-in-progress: true

jobs:
  release_notes_check:
    if: "${{ startsWith(github.event.head_commit.message || '', 'chore: bump version to v') }}"
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get version
        id: version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"
          
      - name: Echo version for deploy
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## ðŸš€ Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          version_file: 'package.json'
          notes_dir: 'docs/release_notes'
          notes_ext: '.md'
          
  deploy_android:
    runs-on: ubuntu-latest
    needs: [release_notes_check]
    steps:
      - name: Checkout (app)
        uses: actions/checkout@v4
          
      - name: Inject Doppler Production Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PRODUCTION_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: production
          working_directory: .
          
      - name: Deploy Android app to Play Store
        id: deploy_android_production
        uses: ./.github/actions/deploy_android_production
        with:
          ANDROID_APP_IDENTIFIER: ${{ secrets.ANDROID_APP_IDENTIFIER }}
          GPLAY_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GPLAY_SERVICE_ACCOUNT_KEY_JSON }}
          ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}
          
      - name: Android deployment summary
        if: success()
        run: |
          echo "## âœ… Android Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "Version ${{ needs.release_notes_check.outputs.version }} deployed to Play Store" >> $GITHUB_STEP_SUMMARY
          
  deploy_ios:
    runs-on: macos-15
    needs: [release_notes_check]
    timeout-minutes: 30
    steps:
      - name: Checkout (app)
        uses: actions/checkout@v4
          
      - name: Inject Doppler Production Secrets
        uses: ./.github/actions/inject_doppler_secrets
        with:
          doppler_token: ${{ secrets.DOPPLER_PRODUCTION_TOKEN }}
          doppler_project: react-native-template
          doppler_environment: production
          working_directory: . 
          
      - name: Deploy iOS app to App Store
        uses: ./.github/actions/deploy_ios_production
        with:
          RELEASE_NOTES: ${{ needs.release_notes_check.outputs.release_notes }}
          IOS_MATCH_PASSWORD: ${{ secrets.IOS_MATCH_PASSWORD }}
          IOS_MATCH_REPOSITORY_URL: ${{ secrets.IOS_MATCH_REPOSITORY_URL }}
          IOS_APPLE_ID: ${{ secrets.IOS_APPLE_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          IOS_APP_STORE_CONNECT_API_KEY_B64: ${{ secrets.IOS_APP_STORE_CONNECT_API_KEY_B64 }}
          IOS_APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER }}
          IOS_APP_STORE_TEAM_ID: ${{ secrets.IOS_APP_STORE_TEAM_ID }}
          IOS_DEV_EMAIL: ${{ secrets.IOS_DEV_EMAIL }}
          IOS_MATCH_DEPLOY_KEY: ${{ secrets.IOS_MATCH_DEPLOY_KEY }}
          
      - name: iOS deployment summary
        if: success()
        run: |
          echo "## âœ… iOS Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "Version ${{ needs.release_notes_check.outputs.version }} deployed to App Store" >> $GITHUB_STEP_SUMMARY
