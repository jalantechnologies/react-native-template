default_platform(:ios)

platform :ios do
  # Setup keychain for code signing
  create_keychain(
    name: "ios.keychain",
    password: ENV["IOS_KEYCHAIN_PASSWORD"],
    default_keychain: true,
    unlock: true,
    timeout: 1800
  )
  
  # Fetch App Store and Development signing certificates for CI environment.
  # Both are required to unlock build and test capabilities in GitHub Actions.
  desc "Fetch certificates for CI"
  lane :ci_signing_setup do
    match(type: "appstore", readonly: true, keychain_name: "ios.keychain", keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"])
  end
  # Deploys a PR build to TestFlight (internal testers only).
  # This lane is triggered from CI and uses environment variables to stay generic.
  # Upload fails if required env vars or bundle outputs are missing.
  desc "Build and upload Preview app to TestFlight"
  lane :pr_deploy do
    require_relative "scripts/ios_deploy_preview"

    ios_deploy_preview!(
      pr_number: ENV["PR_NUMBER"],
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      xcodeproj: "Boilerplate.xcodeproj",
      scheme: "Boilerplate",
      workspace: "Boilerplate.xcworkspace",
      api_key_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      api_key_b64: ENV['IOS_APP_STORE_CONNECT_API_KEY_B64'],
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"],
      apple_id: ENV["IOS_APPLE_ID"],
      username: ENV["FASTLANE_USER"],
      team_id: ENV["IOS_APP_STORE_TEAM_ID"],
      release_notes: ENV["RELEASE_NOTES"]
    )
  end
  # Removes any Preview builds uploaded via pr_deploy for this PR.
  # Should be called when PRs are closed or merged to keep TestFlight clean.
  desc "Cleanup Preview app build for PR"
  lane :pr_cleanup do
    require_relative "scripts/ios_cleanup_preview"

    ios_cleanup_preview!(
      pr_number: ENV["PR_NUMBER"],
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      api_key_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      api_key_b64: ENV['IOS_APP_STORE_CONNECT_API_KEY_B64']
    )
  end

  desc "Build Permanent Preview IPA for GitHub Release"
  lane :ios_permanent_preview do |options|
    require_relative "scripts/ios_preview_builder"

    create_keychain(
      name: "ios.keychain",
      password: ENV["IOS_KEYCHAIN_PASSWORD"],
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    profile_name = "match AppStore #{ENV["IOS_APP_IDENTIFIER"]}"
    match(
      type: "appstore",
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      readonly: true,
      verbose: true,
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"],
      team_id: ENV["IOS_APP_STORE_TEAM_ID"]
    )

    ios_build_preview!(
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      xcodeproj: "Boilerplate.xcodeproj",
      scheme: "Boilerplate",
      workspace: "Boilerplate.xcworkspace",
      team_id: ENV["IOS_APP_STORE_TEAM_ID"],
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"],
      output_directory: options.fetch(:output_directory, "../preview-artifacts"),
      output_name: options.fetch(:output_name, "react-native-template-preview.ipa"),
      build_number: options.fetch(:build_number),
      profile_name: profile_name
    )
  end

  # Deploys the production app to the App Store
  desc "Build and upload Production app to App Store"
  lane :production_deploy do
    require_relative "scripts/ios_deploy_production"

    ios_deploy_production!(
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      xcodeproj: "Boilerplate.xcodeproj",
      plist_path: 'Boilerplate/Info.plist',
      workspace: "Boilerplate.xcworkspace",
      scheme: "Boilerplate",
      api_key_id: ENV["IOS_APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      api_key_b64: ENV["IOS_APP_STORE_CONNECT_API_KEY_B64"],
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"],
      team_id: ENV["IOS_APP_STORE_TEAM_ID"],
      release_notes: ENV["RELEASE_NOTES"]
    )
  end
end
