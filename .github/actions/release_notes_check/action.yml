name: Release Notes Check
description: Checks if release notes file exists for the current version and outputs the content.

inputs:
  version_file:
    description: 'Path to the version file (default: package.json)'
    required: false
    default: 'package.json'
  notes_dir:
    description: 'Directory containing release notes (default: docs/release_notes)'
    required: false
    default: 'docs/release_notes'
  notes_ext:
    description: 'Release notes file extension (default: .md)'
    required: false
    default: '.md'
  notes_file:
    description: 'Optional explicit release notes file path. When set, version/dir/ext are ignored and version_file is not required.'
    required: false
    default: ''

outputs:
  release_notes:
    description: 'Content of the release notes file'
    value: ${{ steps.check_notes.outputs.release_notes }}

runs:
  using: "composite"
  steps:
    - name: Extract version from JSON
      id: get_version
      shell: bash
      run: |
        if [ -n "${{ inputs.notes_file }}" ]; then
          echo "notes_file provided; skipping version extraction."
          echo "version=" >> $GITHUB_OUTPUT
        else
          VERSION=$(jq -r .version < "${{ inputs.version_file }}")
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi

    - name: Check for release notes file
      id: check_notes
      shell: bash
      run: |
        if [ -n "${{ inputs.notes_file }}" ]; then
          NOTES_FILE="${{ inputs.notes_file }}"
          echo "Using explicit release notes file: $NOTES_FILE"
        else
          NOTES_FILE="${{ inputs.notes_dir }}/${{ steps.get_version.outputs.version }}${{ inputs.notes_ext }}"
          echo "Checking release notes file derived from version: $NOTES_FILE"
        fi

        if [ ! -f "$NOTES_FILE" ]; then
          echo "::error::‚ùå Release notes file not found: $NOTES_FILE"
          exit 1
        fi

        echo "‚úÖ Release notes file found: $NOTES_FILE"

        CONTENT=$(cat "$NOTES_FILE")
        CONTENT_LENGTH=$(printf "%s" "$CONTENT" | wc -c | tr -d ' ')
        echo "üìè Raw release notes length: $CONTENT_LENGTH"

        STRIPPED_CONTENT=$(printf "%s" "$CONTENT" | tr -d '[:space:]')
        STRIPPED_LENGTH=${#STRIPPED_CONTENT}

        if [ "$STRIPPED_LENGTH" -eq 0 ]; then
          echo "::error::‚ùå Release notes file is empty or contains only whitespace: $NOTES_FILE"
          exit 1
        fi

        PLACEHOLDER_PATTERN="<enter release notes for the next version here"
        if printf "%s" "$CONTENT" | grep -qi "$PLACEHOLDER_PATTERN"; then
          echo "::error::‚ùå Release notes still contain placeholder text. Please replace the template with actual notes."
          exit 1
        fi

        if [ "$CONTENT_LENGTH" -gt 500 ]; then
          echo "::warning::Release notes exceed 500 characters (${CONTENT_LENGTH}), truncating."
        fi

        TRIMMED_CONTENT=$(printf "%s" "$CONTENT" | head -c 500)

        ANDROID_CHANGELOG_DIR="android/fastlane/metadata/android/en-US/changelogs"
        mkdir -p "$ANDROID_CHANGELOG_DIR"

        ANDROID_CHANGELOG_PATH="$ANDROID_CHANGELOG_DIR/default.txt"
        printf "%s" "$TRIMMED_CONTENT" > "$ANDROID_CHANGELOG_PATH"
        echo "üìù Wrote Android changelog to $ANDROID_CHANGELOG_PATH"

        {
          echo 'release_notes<<EOF'
          echo "$TRIMMED_CONTENT"
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
