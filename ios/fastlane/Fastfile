default_platform(:ios)

platform :ios do
  # Setup keychain for code signing
  create_keychain(
    name: "ios.keychain",
    password: ENV["IOS_KEYCHAIN_PASSWORD"],
    default_keychain: true,
    unlock: true,
    timeout: 1800
  )
  
  # Fetch App Store and Development signing certificates for CI environment.
  # Both are required to unlock build and test capabilities in GitHub Actions.
  desc "Fetch certificates for CI"
 lane :ci_signing_setup do
    match(type: "appstore", readonly: true, keychain_name: "ios.keychain", keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"])
  end
  # Deploys a PR build to TestFlight (internal testers only).
  # This lane is triggered from CI and uses environment variables to stay generic.
  # Upload fails if required env vars or bundle outputs are missing.
  desc "Build and upload Preview app to TestFlight"
  lane :pr_deploy do
    require_relative "scripts/ios_deploy_preview"

    ios_deploy_preview!(
      pr_number: ENV["PR_NUMBER"],
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      xcodeproj: "Boilerplate.xcodeproj",
      scheme: "Boilerplate",
      api_key_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      api_key_b64: ENV['IOS_APP_STORE_CONNECT_API_KEY_B64'],
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"],
      apple_id: ENV["IOS_APPLE_ID"],
      username: ENV["FASTLANE_USER"],
      team_id: ENV["IOS_APP_STORE_TEAM_ID"]
    )
  end
  # Removes any Preview builds uploaded via pr_deploy for this PR.
  # Should be called when PRs are closed or merged to keep TestFlight clean.
  desc "Cleanup Preview app build for PR"
  lane :pr_cleanup do
    require_relative "scripts/ios_cleanup_preview"

    ios_cleanup_preview!(
      pr_number: ENV["PR_NUMBER"],
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      api_key_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      api_key_b64: ENV['IOS_APP_STORE_CONNECT_API_KEY_B64']
    )
  end
  # Deploys the production app to the App Store
  desc "Build and upload Production app to App Store"
  lane :production_deploy do
    require_relative "scripts/ios_deploy_production"

    ios_deploy_production!(
      app_identifier: ENV["IOS_APP_IDENTIFIER"],
      workspace: "Boilerplate.xcworkspace",
      scheme: "Boilerplate",
      api_key_id: ENV["IOS_APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["IOS_APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      api_key_b64: ENV["IOS_APP_STORE_CONNECT_API_KEY_B64"],
      keychain_name: "ios.keychain",
      keychain_password: ENV["IOS_KEYCHAIN_PASSWORD"],
      team_id: ENV["IOS_APP_STORE_TEAM_ID"]
    )
  end
end
