default_platform(:ios)

platform :ios do
  desc "Clean caches, inject .env, and build the app"
  lane :clean_build do
    # 1. Remove Xcode derived data
    sh "rm -rf ~/Library/Developer/Xcode/DerivedData"
    # 2. Clear watchman (Metro) and yarn caches
    sh "watchman watch-del-all"
    sh "yarn cache clean"
    sh "pwd"  # This will print the current directory for debugging
    
    Dir.chdir("../") do
      # NOTE: Fastfile lives in ios/fastlane, so ../ ‚Üí ios/
      envfile = "../.env"
      sh "pod deintegrate"
      sh "ENVFILE=#{envfile} pod install --repo-update"

      ws  = Dir.glob("*.xcworkspace").first            # e.g. "MyApp.xcworkspace"
      app = File.basename(ws, ".xcworkspace")           # e.g. "MyApp"

      sh %(
        xcodebuild \
          -workspace #{ws} \
          -scheme #{app} \
          -configuration Release \
          -derivedDataPath build/DerivedData \
          -allowProvisioningUpdates \
          clean build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_STYLE=Manual
      )
      app_dir = "build/DerivedData/Build/Products/Release-iphoneos/#{app}.app"
      sh "echo"
      sh "echo \"üîç Built .app bundle path:\""
      sh "echo \"  #{File.expand_path(app_dir)}\""
      sh "ls -ld #{app_dir}"  # list the bundle directory
      sh "echo"
    end
  end
end
